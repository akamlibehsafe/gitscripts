#!/bin/bash

# gitak_setup_symlinks
# Creates symlinks in ~/bin/ pointing to the git scripts in this repository.
# This allows you to keep the scripts in the repo folder while using them from anywhere.

set -e

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# Function to print error messages
error() {
    echo -e "${RED}Error: $1${NC}" >&2
    exit 1
}

# Function to print success messages
success() {
    echo -e "${GREEN}$1${NC}"
}

# Function to print info messages
info() {
    echo -e "${YELLOW}$1${NC}"
}

# Function to print prompt messages
prompt() {
    echo -e "${BLUE}$1${NC}"
}

# Get the directory where this script is located (the repository root)
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd -P)"

info "Git Scripts Symlink Setup"
info "=========================="
echo ""
info "This script will create symlinks in ~/bin/ pointing to the scripts in:"
echo "  $SCRIPT_DIR/scripts"
echo ""

# Check if ~/bin exists, create if not
if [ ! -d "$HOME/bin" ]; then
    info "Creating ~/bin directory..."
    mkdir -p "$HOME/bin"
    success "Created ~/bin directory"
else
    info "~/bin directory already exists"
fi

# Ensure ~/bin is in PATH
if [[ ":$PATH:" != *":$HOME/bin:"* ]]; then
    info "Adding ~/bin to PATH..."
    
    # Detect shell
    SHELL_NAME=$(basename "$SHELL")
    if [ "$SHELL_NAME" = "zsh" ]; then
        SHELL_CONFIG="$HOME/.zshrc"
    elif [ "$SHELL_NAME" = "bash" ]; then
        if [ -f "$HOME/.bash_profile" ]; then
            SHELL_CONFIG="$HOME/.bash_profile"
        else
            SHELL_CONFIG="$HOME/.bashrc"
        fi
    else
        SHELL_CONFIG="$HOME/.profile"
    fi
    
    if [ -f "$SHELL_CONFIG" ]; then
        if ! grep -q 'export PATH="$HOME/bin:$PATH"' "$SHELL_CONFIG"; then
            echo '' >> "$SHELL_CONFIG"
            echo '# Add ~/bin to PATH for git scripts' >> "$SHELL_CONFIG"
            echo 'export PATH="$HOME/bin:$PATH"' >> "$SHELL_CONFIG"
            success "Added ~/bin to PATH in $SHELL_CONFIG"
            info "Run: source $SHELL_CONFIG (or restart your terminal)"
        else
            info "~/bin is already in PATH in $SHELL_CONFIG"
        fi
    else
        info "Could not detect shell config file. Please manually add to your shell config:"
        echo "  export PATH=\"\$HOME/bin:\$PATH\""
    fi
else
    info "~/bin is already in PATH"
fi

echo ""
info "Creating symlinks..."

# List of scripts to symlink (located in scripts/ subdirectory)
SCRIPTS=(
    "gitak_install"
    "gitak_create_from_local"
    "gitak_create_from_remote"
    "gitak_push"
    "gitak_verify_PAT"
    "zsh_install"
)

SYMLINKS_CREATED=0
SYMLINKS_UPDATED=0
SYMLINKS_SKIPPED=0

for script in "${SCRIPTS[@]}"; do
    SCRIPT_PATH="$SCRIPT_DIR/scripts/$script"
    SYMLINK_PATH="$HOME/bin/$script"
    
    # Check if script exists in repo
    if [ ! -f "$SCRIPT_PATH" ]; then
        info "  ⚠ Skipping $script (not found in repository)"
        SYMLINKS_SKIPPED=$((SYMLINKS_SKIPPED + 1))
        continue
    fi
    
    # Check if symlink already exists
    if [ -L "$SYMLINK_PATH" ]; then
        # Check if it points to the correct location
        CURRENT_TARGET=$(readlink "$SYMLINK_PATH")
        ABSOLUTE_TARGET=$(cd "$(dirname "$SYMLINK_PATH")" && cd "$(dirname "$CURRENT_TARGET")" && pwd)/$(basename "$CURRENT_TARGET")
        ABSOLUTE_SCRIPT=$(cd "$(dirname "$SCRIPT_PATH")" && pwd)/$(basename "$SCRIPT_PATH")
        
        if [ "$ABSOLUTE_TARGET" = "$ABSOLUTE_SCRIPT" ]; then
            info "  ✓ $script (symlink already exists and points to correct location)"
            SYMLINKS_SKIPPED=$((SYMLINKS_SKIPPED + 1))
        else
            info "  ↻ Updating $script (symlink exists but points elsewhere)"
            rm "$SYMLINK_PATH"
            ln -s "$SCRIPT_PATH" "$SYMLINK_PATH"
            success "    Created symlink: $SYMLINK_PATH -> $SCRIPT_PATH"
            SYMLINKS_UPDATED=$((SYMLINKS_UPDATED + 1))
        fi
    elif [ -f "$SYMLINK_PATH" ]; then
        # File exists but is not a symlink
        info "  ⚠ $script (file exists at ~/bin/$script, not a symlink)"
        prompt "    Overwrite? (y/N): "
        read -r response
        if [[ "$response" =~ ^[Yy]$ ]]; then
            rm "$SYMLINK_PATH"
            ln -s "$SCRIPT_PATH" "$SYMLINK_PATH"
            success "    Created symlink: $SYMLINK_PATH -> $SCRIPT_PATH"
            SYMLINKS_CREATED=$((SYMLINKS_CREATED + 1))
        else
            info "    Skipped $script"
            SYMLINKS_SKIPPED=$((SYMLINKS_SKIPPED + 1))
        fi
    else
        # Create new symlink
        ln -s "$SCRIPT_PATH" "$SYMLINK_PATH"
        success "  ✓ Created symlink: $script"
        SYMLINKS_CREATED=$((SYMLINKS_CREATED + 1))
    fi
done

echo ""
info "Summary:"
echo "  Created: $SYMLINKS_CREATED"
echo "  Updated: $SYMLINKS_UPDATED"
echo "  Skipped: $SYMLINKS_SKIPPED"
echo ""

# Verify symlinks
info "Verifying symlinks..."
ALL_VALID=true
for script in "${SCRIPTS[@]}"; do
    SYMLINK_PATH="$HOME/bin/$script"
    if [ -L "$SYMLINK_PATH" ]; then
        if [ -f "$(readlink -f "$SYMLINK_PATH")" ]; then
            success "  ✓ $script is valid"
        else
            error "  ✗ $script points to non-existent file"
            ALL_VALID=false
        fi
    elif [ ! -f "$SCRIPT_DIR/scripts/$script" ]; then
        # Script doesn't exist in repo, that's okay
        true
    else
        error "  ✗ $script symlink was not created"
        ALL_VALID=false
    fi
done

if [ "$ALL_VALID" = true ]; then
    echo ""
    success "Setup complete! ✓"
    echo ""
    info "You can now use the scripts from anywhere:"
    echo "  gitak_create_from_local <user/repo>"
    echo "  gitak_create_from_remote <user/repo>"
    echo "  gitak_push [directory] [-m \"message\"]"
    echo "  gitak_install"
    echo "  gitak_verify_PAT"
    echo "  zsh_install"
    echo ""
    info "Note: If ~/bin was just added to PATH, you may need to:"
    echo "  source $SHELL_CONFIG"
    echo "  (or restart your terminal)"
else
    error "Some symlinks could not be created. Please check the errors above."
fi
