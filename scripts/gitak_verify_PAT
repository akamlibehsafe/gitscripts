#!/bin/bash

# gitak_verify_PAT
# Helper script to verify PAT tokens are set up correctly

set -e

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# Function to print error messages
error() {
    echo -e "${RED}✗ $1${NC}" >&2
}

# Function to print success messages
success() {
    echo -e "${GREEN}✓ $1${NC}"
}

# Function to print info messages
info() {
    echo -e "${YELLOW}ℹ $1${NC}"
}

# Function to print section headers
section() {
    echo ""
    echo -e "${BLUE}=== $1 ===${NC}"
    echo ""
}

section "PAT Token Verification"

# Check if curl is available
if ! command -v curl &> /dev/null; then
    error "curl is not installed. Please install it first."
    exit 1
fi

# Check if jq is available (optional but helpful)
HAS_JQ=false
if command -v jq &> /dev/null; then
    HAS_JQ=true
fi

# Function to verify a PAT token
verify_pat() {
    local PAT_VAR=$1
    local EXPECTED_USER=$2
    
    echo ""
    info "Checking $PAT_VAR..."
    
    # Check if variable is set
    local PAT="${!PAT_VAR}"
    if [ -z "$PAT" ]; then
        error "$PAT_VAR is not set"
        echo "   Set it with: export $PAT_VAR=\"your_token_here\""
        return 1
    fi
    
    success "$PAT_VAR is set"
    
    # Check token format (GitHub PATs typically start with ghp_ for classic tokens)
    if [[ ! "$PAT" =~ ^ghp_|^github_pat_ ]]; then
        info "Warning: PAT format looks unusual (should start with 'ghp_' or 'github_pat_')"
    fi
    
    # Verify token with GitHub API
    info "Verifying token with GitHub API..."
    
    API_RESPONSE=$(curl -s -w "\n%{http_code}" \
        -H "Accept: application/vnd.github.v3+json" \
        -H "Authorization: token $PAT" \
        https://api.github.com/user)
    
    HTTP_CODE=$(echo "$API_RESPONSE" | tail -n1)
    API_BODY=$(echo "$API_RESPONSE" | sed '$d')
    
    if [ "$HTTP_CODE" -eq 200 ]; then
        success "Token is valid"
        
        # Extract user info if jq is available
        if [ "$HAS_JQ" = true ]; then
            AUTH_USER=$(echo "$API_BODY" | jq -r '.login' 2>/dev/null || echo "")
            AUTH_NAME=$(echo "$API_BODY" | jq -r '.name // "N/A"' 2>/dev/null || echo "")
            
            if [ -n "$AUTH_USER" ] && [ "$AUTH_USER" != "null" ]; then
                echo "   Authenticated as: $AUTH_USER"
                if [ -n "$AUTH_NAME" ] && [ "$AUTH_NAME" != "null" ] && [ "$AUTH_NAME" != "N/A" ]; then
                    echo "   Name: $AUTH_NAME"
                fi
                
                # Check if it matches expected user
                if [ -n "$EXPECTED_USER" ]; then
                    if [ "$AUTH_USER" = "$EXPECTED_USER" ]; then
                        success "Token belongs to correct account: $EXPECTED_USER"
                    else
                        error "Token belongs to '$AUTH_USER', but expected '$EXPECTED_USER'"
                        echo "   Please use the correct PAT for the $EXPECTED_USER account"
                        return 1
                    fi
                fi
            fi
        fi
        
        # Check scopes (this requires a different endpoint or we can infer from ability to create repos)
        info "Checking token permissions..."
        
        # Try to check rate limit to verify token works
        RATE_LIMIT_RESPONSE=$(curl -s \
            -H "Accept: application/vnd.github.v3+json" \
            -H "Authorization: token $PAT" \
            https://api.github.com/rate_limit)
        
        if [ "$HAS_JQ" = true ]; then
            RATE_LIMIT=$(echo "$RATE_LIMIT_RESPONSE" | jq -r '.rate.limit' 2>/dev/null || echo "unknown")
            RATE_REMAINING=$(echo "$RATE_LIMIT_RESPONSE" | jq -r '.rate.remaining' 2>/dev/null || echo "unknown")
            echo "   API rate limit: $RATE_REMAINING / $RATE_LIMIT"
        fi
        
        # Note: We can't directly check scopes with v3 API, but we can note what's needed
        info "Note: Token needs 'repo' scope to create repositories"
        echo "   If you get 403 errors, regenerate the token with 'repo' scope enabled"
        
        return 0
        
    elif [ "$HTTP_CODE" -eq 401 ]; then
        error "Token is invalid or expired (HTTP 401)"
        echo "   Please regenerate your token: https://github.com/settings/tokens"
        return 1
        
    elif [ "$HTTP_CODE" -eq 403 ]; then
        error "Token doesn't have required permissions (HTTP 403)"
        echo "   The token needs the 'repo' scope"
        echo "   Regenerate with 'repo' scope: https://github.com/settings/tokens"
        return 1
        
    else
        error "Unexpected response (HTTP $HTTP_CODE)"
        echo "   Response: $API_BODY"
        return 1
    fi
}

# Verify both PATs
verify_pat "GH_TOKEN_fortegb" "fortegb"
FORTEGB_STATUS=$?

verify_pat "GH_TOKEN_akamlibehsafe" "akamlibehsafe"
AKAMLIBEH_STATUS=$?

# Summary
section "Summary"

if [ $FORTEGB_STATUS -eq 0 ] && [ $AKAMLIBEH_STATUS -eq 0 ]; then
    success "All PAT tokens are configured correctly!"
    echo ""
    info "You should be able to use all Git automation scripts now."
elif [ $FORTEGB_STATUS -eq 0 ]; then
    error "GH_TOKEN_akamlibehsafe needs attention"
    exit 1
elif [ $AKAMLIBEH_STATUS -eq 0 ]; then
    error "GH_TOKEN_fortegb needs attention"
    exit 1
else
    error "Both PAT tokens need attention"
    exit 1
fi

