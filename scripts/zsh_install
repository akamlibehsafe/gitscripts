#!/bin/bash

# zsh_install
# Installs and configures iTerm2, Zsh, Oh My Zsh, Powerlevel10k theme, and MesloLGS NF font
# to create a beautiful, Git-aware shell prompt with icons.

set -e  # Exit on error

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[1;34m'
NC='\033[0m' # No Color

# Function to print error messages
error() {
    echo -e "${RED}Error: $1${NC}" >&2
    exit 1
}

# Function to print success messages
success() {
    echo -e "${GREEN}$1${NC}"
}

# Function to print info messages
info() {
    echo -e "${YELLOW}$1${NC}"
}

# Function to print prompt messages
prompt() {
    echo -e "${BLUE}$1${NC}"
}

# Function to print section headers
section() {
    echo ""
    echo -e "${BLUE}=== $1 ===${NC}"
    echo ""
}

# Check if running on macOS
if [[ "$OSTYPE" != "darwin"* ]]; then
    error "This script is designed for macOS only. Detected OS: $OSTYPE"
fi

info "Starting Shell Prompt Setup for macOS..."
info "This script will install iTerm2, Zsh, Oh My Zsh, Powerlevel10k theme, and required fonts."

# Detect shell type for configuration file
SHELL_NAME=$(basename "$SHELL")
SHELL_CONFIG=""

if [[ "$SHELL_NAME" == "zsh" ]]; then
    SHELL_CONFIG="$HOME/.zshrc"
elif [[ "$SHELL_NAME" == "bash" ]]; then
    SHELL_CONFIG="$HOME/.bashrc"
    if [ -f "$HOME/.bash_profile" ] && [ ! -f "$HOME/.bashrc" ]; then
        SHELL_CONFIG="$HOME/.bash_profile"
    fi
else
    info "Warning: Unknown shell '$SHELL_NAME'. Defaulting to .zshrc"
    SHELL_CONFIG="$HOME/.zshrc"
fi

info "Detected shell: $SHELL_NAME"
info "Configuration file: $SHELL_CONFIG"

section "Step 1: Homebrew Installation"

# Check if Homebrew is installed
if command -v brew &> /dev/null; then
    success "Homebrew is already installed"
    info "Updating Homebrew..."
    brew update || info "Homebrew update skipped (may require manual intervention)"
else
    info "Homebrew is not installed. Installing Homebrew..."
    info "This will prompt for your password..."
    
    # Install Homebrew (non-interactive mode where possible)
    /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)" || {
        error "Homebrew installation failed. Please install manually from https://brew.sh"
    }
    
    # Add Homebrew to PATH if not already there (newer Macs with Apple Silicon)
    if [[ -f "/opt/homebrew/bin/brew" ]]; then
        export PATH="/opt/homebrew/bin:$PATH"
        info "Added Homebrew to PATH for this session"
    elif [[ -f "/usr/local/bin/brew" ]]; then
        export PATH="/usr/local/bin:$PATH"
        info "Added Homebrew to PATH for this session"
    fi
    
    success "Homebrew installed successfully"
fi

# Verify brew is in PATH
if ! command -v brew &> /dev/null; then
    error "Homebrew installation completed but 'brew' command not found in PATH.\nPlease add Homebrew to your PATH:\n  For Apple Silicon: export PATH=\"/opt/homebrew/bin:\$PATH\"\n  For Intel: export PATH=\"/usr/local/bin:\$PATH\""
fi

BREW_VERSION=$(brew --version | head -n1)
success "Homebrew ready: $BREW_VERSION"

section "Step 2: Git Installation Check"

# Check if Git is installed (required for cloning repos)
if command -v git &> /dev/null; then
    GIT_VERSION=$(git --version)
    success "Git is already installed: $GIT_VERSION"
else
    info "Git is not installed. Installing Git via Homebrew..."
    brew install git || error "Failed to install Git"
    success "Git installed successfully"
fi

section "Step 3: iTerm2 Installation"

# Check if iTerm2 is already installed
if [ -d "/Applications/iTerm.app" ]; then
    success "iTerm2 is already installed"
    ITERM_VERSION=$(/usr/libexec/PlistBuddy -c "Print:CFBundleShortVersionString" /Applications/iTerm.app/Contents/Info.plist 2>/dev/null || echo "unknown")
    info "iTerm2 version: $ITERM_VERSION"
else
    info "iTerm2 is not installed. Installing via Homebrew Cask..."
    brew install --cask iterm2 || error "Failed to install iTerm2"
    success "iTerm2 installed successfully"
    info "Note: You may need to open iTerm2 manually after this script completes."
fi

section "Step 4: Zsh Configuration"

# Check if Zsh is available
if command -v zsh &> /dev/null; then
    ZSH_VERSION=$(zsh --version | cut -d' ' -f2)
    success "Zsh is available: version $ZSH_VERSION"
else
    error "Zsh is not available. This script requires Zsh to be installed."
fi

# Check current default shell
CURRENT_SHELL=$(dscl . -read /Users/$(whoami) UserShell | awk '{print $2}')
ZSH_PATH=$(which zsh)

if [[ "$CURRENT_SHELL" == "$ZSH_PATH" ]]; then
    success "Zsh is already set as your default shell"
else
    info "Current default shell: $CURRENT_SHELL"
    info "Zsh path: $ZSH_PATH"
    prompt "Do you want to change your default shell to Zsh? (Y/n)"
    read -r CHANGE_SHELL
    
    if [[ ! "$CHANGE_SHELL" =~ ^[Nn]$ ]]; then
        info "Changing default shell to Zsh..."
        # Use chsh to change shell
        if sudo chsh -s "$ZSH_PATH" "$(whoami)"; then
            success "Default shell changed to Zsh"
            info "Note: This change will take effect in new terminal sessions."
        else
            info "Could not automatically change shell. You can change it manually with:"
            echo "  chsh -s $ZSH_PATH"
        fi
    else
        info "Keeping current default shell"
    fi
fi

section "Step 5: Oh My Zsh Installation"

# Check if Oh My Zsh is already installed (verify the main script exists, not just the directory)
if [ -f "$HOME/.oh-my-zsh/oh-my-zsh.sh" ]; then
    success "Oh My Zsh is already installed"
elif [ -d "$HOME/.oh-my-zsh" ]; then
    info "Oh My Zsh directory exists but installation appears incomplete"
    info "Reinstalling Oh My Zsh..."
    
    # Backup custom directory if it exists (contains themes/plugins)
    if [ -d "$HOME/.oh-my-zsh/custom" ]; then
        info "Backing up custom themes and plugins..."
        mv "$HOME/.oh-my-zsh" "$HOME/.oh-my-zsh.backup.$(date +%Y%m%d_%H%M%S)"
    else
        rm -rf "$HOME/.oh-my-zsh"
    fi
    
    # Backup existing .zshrc if it exists
    if [ -f "$HOME/.zshrc" ]; then
        BACKUP_FILE="$HOME/.zshrc.backup.$(date +%Y%m%d_%H%M%S)"
        info "Backing up existing .zshrc to $BACKUP_FILE"
        cp "$HOME/.zshrc" "$BACKUP_FILE"
        success "Backup created"
    fi
    
    # Install Oh My Zsh in unattended mode
    # RUNZSH=no: Don't run zsh after installation
    # CHSH=no: Don't try to change the default shell (we handle this separately)
    # KEEP_ZSHRC=no: Replace existing .zshrc (we've already backed it up)
    if RUNZSH=no CHSH=no KEEP_ZSHRC=no sh -c "$(curl -fsSL https://raw.githubusercontent.com/ohmyzsh/ohmyzsh/master/tools/install.sh)"; then
        success "Oh My Zsh installed successfully"
        
        # Restore custom directory if it was backed up
        LATEST_BACKUP=$(ls -td "$HOME/.oh-my-zsh.backup."* 2>/dev/null | head -n1)
        if [ -n "$LATEST_BACKUP" ] && [ -d "$LATEST_BACKUP/custom" ]; then
            info "Restoring custom themes and plugins..."
            cp -r "$LATEST_BACKUP/custom/"* "$HOME/.oh-my-zsh/custom/" 2>/dev/null && \
                success "Custom themes and plugins restored" || \
                info "Note: Some custom files may need to be restored manually"
        fi
    else
        error "Oh My Zsh installation failed. Please install manually from https://ohmyz.sh"
    fi
else
    info "Oh My Zsh is not installed. Installing Oh My Zsh..."
    
    # Backup existing .zshrc if it exists
    if [ -f "$HOME/.zshrc" ]; then
        BACKUP_FILE="$HOME/.zshrc.backup.$(date +%Y%m%d_%H%M%S)"
        info "Backing up existing .zshrc to $BACKUP_FILE"
        cp "$HOME/.zshrc" "$BACKUP_FILE"
        success "Backup created"
    fi
    
    # Install Oh My Zsh in unattended mode
    # RUNZSH=no: Don't run zsh after installation
    # CHSH=no: Don't try to change the default shell (we handle this separately)
    # KEEP_ZSHRC=no: Replace existing .zshrc (we've already backed it up)
    if RUNZSH=no CHSH=no KEEP_ZSHRC=no sh -c "$(curl -fsSL https://raw.githubusercontent.com/ohmyzsh/ohmyzsh/master/tools/install.sh)"; then
        success "Oh My Zsh installed successfully"
    else
        error "Oh My Zsh installation failed. Please install manually from https://ohmyz.sh"
    fi
fi

# Verify installation was successful
if [ ! -f "$HOME/.oh-my-zsh/oh-my-zsh.sh" ]; then
    error "Oh My Zsh installation verification failed. The main script file is missing."
fi

section "Step 6: Powerlevel10k Theme Installation"

ZSH_CUSTOM="${ZSH_CUSTOM:-$HOME/.oh-my-zsh/custom}"
P10K_THEME_DIR="$ZSH_CUSTOM/themes/powerlevel10k"

# Check if Powerlevel10k is already installed
if [ -d "$P10K_THEME_DIR" ]; then
    success "Powerlevel10k theme is already installed"
else
    info "Powerlevel10k theme is not installed. Installing..."
    
    # Create custom themes directory if it doesn't exist
    mkdir -p "$ZSH_CUSTOM/themes" || error "Failed to create custom themes directory"
    
    # Clone Powerlevel10k repository
    if git clone --depth=1 https://github.com/romkatv/powerlevel10k.git "$P10K_THEME_DIR" 2>/dev/null; then
        success "Powerlevel10k theme installed successfully"
    else
        error "Failed to install Powerlevel10k theme. Please check your internet connection."
    fi
fi

# Configure .zshrc to use Powerlevel10k
info "Configuring .zshrc to use Powerlevel10k theme..."

# Ensure .zshrc exists
if [ ! -f "$HOME/.zshrc" ]; then
    info "Creating .zshrc file..."
    touch "$HOME/.zshrc"
fi

# Check if Powerlevel10k theme is already set
if grep -q "powerlevel10k/powerlevel10k" "$HOME/.zshrc" 2>/dev/null; then
    info "Powerlevel10k theme is already configured in .zshrc"
else
    # Update ZSH_THEME to powerlevel10k/powerlevel10k
    if grep -q "^ZSH_THEME=" "$HOME/.zshrc" 2>/dev/null; then
        # Replace existing ZSH_THEME line
        if [[ "$OSTYPE" == "darwin"* ]]; then
            sed -i '' 's/^ZSH_THEME=.*/ZSH_THEME="powerlevel10k\/powerlevel10k"/' "$HOME/.zshrc"
        else
            sed -i 's/^ZSH_THEME=.*/ZSH_THEME="powerlevel10k\/powerlevel10k"/' "$HOME/.zshrc"
        fi
        success "Updated ZSH_THEME in .zshrc"
    else
        # Add ZSH_THEME line if it doesn't exist (find a good place to insert it)
        if grep -q "^export ZSH=" "$HOME/.zshrc" 2>/dev/null; then
            # Insert after export ZSH line using awk for better reliability
            awk '/^export ZSH=/ {print; print "ZSH_THEME=\"powerlevel10k/powerlevel10k\""; next}1' "$HOME/.zshrc" > "$HOME/.zshrc.tmp" && mv "$HOME/.zshrc.tmp" "$HOME/.zshrc"
        else
            # Add at the beginning of the file
            echo 'ZSH_THEME="powerlevel10k/powerlevel10k"' > "$HOME/.zshrc.tmp"
            cat "$HOME/.zshrc" >> "$HOME/.zshrc.tmp"
            mv "$HOME/.zshrc.tmp" "$HOME/.zshrc"
        fi
        success "Added ZSH_THEME to .zshrc"
    fi
fi

# Add configuration to disable Powerlevel10k wizard on first run
if ! grep -q "POWERLEVEL9K_DISABLE_CONFIGURATION_WIZARD" "$HOME/.zshrc" 2>/dev/null; then
    info "Adding Powerlevel10k configuration to disable auto-wizard..."
    echo "" >> "$HOME/.zshrc"
    echo "# Powerlevel10k Configuration" >> "$HOME/.zshrc"
    echo "# Run 'p10k configure' to customize your prompt" >> "$HOME/.zshrc"
    echo "POWERLEVEL9K_DISABLE_CONFIGURATION_WIZARD=true" >> "$HOME/.zshrc"
    success "Powerlevel10k configuration added"
fi

section "Step 7: Zsh Plugins Installation"

PLUGINS_DIR="$ZSH_CUSTOM/plugins"

# Create plugins directory if it doesn't exist
mkdir -p "$PLUGINS_DIR" || error "Failed to create plugins directory"

# Install zsh-autosuggestions
AUTOSUGGESTIONS_DIR="$PLUGINS_DIR/zsh-autosuggestions"
if [ -d "$AUTOSUGGESTIONS_DIR" ]; then
    success "zsh-autosuggestions plugin is already installed"
else
    info "Installing zsh-autosuggestions plugin..."
    if git clone https://github.com/zsh-users/zsh-autosuggestions "$AUTOSUGGESTIONS_DIR" 2>/dev/null; then
        success "zsh-autosuggestions plugin installed successfully"
    else
        info "Warning: Failed to install zsh-autosuggestions plugin. Continuing..."
    fi
fi

# Install zsh-syntax-highlighting
SYNTAX_HIGHLIGHTING_DIR="$PLUGINS_DIR/zsh-syntax-highlighting"
if [ -d "$SYNTAX_HIGHLIGHTING_DIR" ]; then
    success "zsh-syntax-highlighting plugin is already installed"
else
    info "Installing zsh-syntax-highlighting plugin..."
    if git clone https://github.com/zsh-users/zsh-syntax-highlighting.git "$SYNTAX_HIGHLIGHTING_DIR" 2>/dev/null; then
        success "zsh-syntax-highlighting plugin installed successfully"
    else
        info "Warning: Failed to install zsh-syntax-highlighting plugin. Continuing..."
    fi
fi

# Update plugins in .zshrc
info "Configuring plugins in .zshrc..."

# Check if plugins are already configured
PLUGINS_LINE=""
if grep -q "^plugins=" "$HOME/.zshrc" 2>/dev/null; then
    # Get existing plugins line
    EXISTING_PLUGINS=$(grep "^plugins=" "$HOME/.zshrc" | head -n1)
    
    # Check if our plugins are already in the list
    if echo "$EXISTING_PLUGINS" | grep -q "zsh-autosuggestions" && \
       echo "$EXISTING_PLUGINS" | grep -q "zsh-syntax-highlighting"; then
        info "Plugins are already configured in .zshrc"
    else
        # Add plugins to existing list (keep existing plugins)
        # Extract existing plugin names
        EXISTING_PLUGIN_LIST=$(echo "$EXISTING_PLUGINS" | sed 's/plugins=(//;s/)//' | tr -d ' ')
        
        # Build new plugins line
        if [ -n "$EXISTING_PLUGIN_LIST" ]; then
            PLUGINS_LINE="plugins=($EXISTING_PLUGIN_LIST zsh-autosuggestions zsh-syntax-highlighting)"
        else
            PLUGINS_LINE='plugins=(zsh-autosuggestions zsh-syntax-highlighting)'
        fi
        
        # Replace plugins line
        if [[ "$OSTYPE" == "darwin"* ]]; then
            sed -i '' "s/^plugins=.*/$PLUGINS_LINE/" "$HOME/.zshrc"
        else
            sed -i "s/^plugins=.*/$PLUGINS_LINE/" "$HOME/.zshrc"
        fi
        success "Updated plugins in .zshrc"
    fi
else
    # Add plugins line if it doesn't exist
    PLUGINS_LINE='plugins=(zsh-autosuggestions zsh-syntax-highlighting)'
    
    # Find a good place to insert it (after ZSH_THEME)
    if grep -q "^ZSH_THEME=" "$HOME/.zshrc" 2>/dev/null; then
        # Use awk for better reliability across platforms
        awk -v plugins_line="$PLUGINS_LINE" '/^ZSH_THEME=/ {print; print plugins_line; next}1' "$HOME/.zshrc" > "$HOME/.zshrc.tmp" && mv "$HOME/.zshrc.tmp" "$HOME/.zshrc"
    else
        # Add at a reasonable location
        echo "$PLUGINS_LINE" >> "$HOME/.zshrc"
    fi
    success "Added plugins configuration to .zshrc"
fi

# Ensure zsh-syntax-highlighting is sourced (it needs to be at the end)
if ! grep -q "source.*zsh-syntax-highlighting" "$HOME/.zshrc" 2>/dev/null; then
    info "Adding zsh-syntax-highlighting source to .zshrc..."
    echo "" >> "$HOME/.zshrc"
    echo "# Load zsh-syntax-highlighting (must be at the end)" >> "$HOME/.zshrc"
    echo "source \$ZSH_CUSTOM/plugins/zsh-syntax-highlighting/zsh-syntax-highlighting.zsh" >> "$HOME/.zshrc"
    success "Added zsh-syntax-highlighting source"
fi

section "Step 8: MesloLGS NF Font Installation"

# Check if font is already installed
FONT_INSTALLED=false
if fc-list 2>/dev/null | grep -qi "MesloLGS.*NF"; then
    success "MesloLGS NF font is already installed"
    FONT_INSTALLED=true
else
    info "MesloLGS NF font is not installed. Installing via Homebrew Cask..."
    
    if brew install --cask font-meslo-lg-nerd-font 2>/dev/null; then
        success "MesloLGS NF font installed successfully"
        FONT_INSTALLED=true
    else
        info "Warning: Homebrew font installation failed. Attempting alternative method..."
        
        # Alternative: Direct download and install
        FONT_DIR="$HOME/Library/Fonts"
        mkdir -p "$FONT_DIR"
        
        info "Downloading MesloLGS NF font directly..."
        
        # Try to download the font files
        FONT_URLS=(
            "https://github.com/romkatv/powerlevel10k-media/raw/master/MesloLGS%20NF%20Regular.ttf"
            "https://github.com/romkatv/powerlevel10k-media/raw/master/MesloLGS%20NF%20Bold.ttf"
            "https://github.com/romkatv/powerlevel10k-media/raw/master/MesloLGS%20NF%20Italic.ttf"
            "https://github.com/romkatv/powerlevel10k-media/raw/master/MesloLGS%20NF%20Bold%20Italic.ttf"
        )
        
        DOWNLOAD_SUCCESS=true
        for url in "${FONT_URLS[@]}"; do
            filename=$(basename "$url" | sed 's/%20/ /g')
            if curl -L -o "$FONT_DIR/$filename" "$url" 2>/dev/null; then
                info "  Downloaded: $filename"
            else
                DOWNLOAD_SUCCESS=false
                info "  Failed to download: $filename"
            fi
        done
        
        if [ "$DOWNLOAD_SUCCESS" = true ]; then
            # Refresh font cache
            if command -v fc-cache &> /dev/null; then
                fc-cache -fv "$FONT_DIR" 2>/dev/null || true
            fi
            
            # Verify installation
            if fc-list 2>/dev/null | grep -qi "MesloLGS.*NF"; then
                success "MesloLGS NF font installed successfully via direct download"
                FONT_INSTALLED=true
            else
                info "Font files downloaded but not detected. Manual installation may be required."
                FONT_INSTALLED=false
            fi
        else
            info "Could not download font files. Manual installation required."
            FONT_INSTALLED=false
        fi
    fi
fi

section "Step 9: iTerm2 Font Configuration"

if [ "$FONT_INSTALLED" = true ]; then
    info "Configuring iTerm2 to use MesloLGS NF font..."
    
    # Check if iTerm2 is installed
    if [ -d "/Applications/iTerm.app" ]; then
        # Attempt to configure font using defaults command
        # This uses iTerm2's preferences plist
        ITERM_PLIST="$HOME/Library/Preferences/com.googlecode.iterm2.plist"
        
        # Note: iTerm2's font configuration is complex and best done through the UI
        # We'll provide instructions for manual configuration
        info "iTerm2 font configuration is best done through the application preferences."
        info "See post-installation instructions below for manual configuration steps."
    else
        info "iTerm2 is not installed. Font configuration will be needed after iTerm2 is opened."
    fi
else
    info "Font is not installed. Please install MesloLGS NF font manually and configure iTerm2."
fi

section "Step 10: Verification"

info "Verifying installation..."

# Verify Oh My Zsh main script file exists
if [ -f "$HOME/.oh-my-zsh/oh-my-zsh.sh" ]; then
    success "Oh My Zsh main script file exists"
else
    error "Oh My Zsh installation is incomplete. The main script file is missing: $HOME/.oh-my-zsh/oh-my-zsh.sh"
fi

# Verify .zshrc has Oh My Zsh sourcing
if grep -q "source.*oh-my-zsh.sh" "$HOME/.zshrc" 2>/dev/null || grep -q "source \$ZSH/oh-my-zsh.sh" "$HOME/.zshrc" 2>/dev/null; then
    success ".zshrc contains Oh My Zsh source line"
else
    info "Warning: .zshrc may be missing Oh My Zsh source line"
    info "This is usually added automatically by Oh My Zsh installer"
    info "If Powerlevel10k doesn't load, check that ~/.zshrc contains:"
    echo "     source \$ZSH/oh-my-zsh.sh"
fi

# Verify Powerlevel10k theme is set
if grep -q "powerlevel10k/powerlevel10k" "$HOME/.zshrc" 2>/dev/null; then
    success "Powerlevel10k theme is configured in .zshrc"
else
    info "Warning: Powerlevel10k theme may not be set in .zshrc"
fi

# Verify Powerlevel10k directory exists
if [ -d "$P10K_THEME_DIR" ]; then
    success "Powerlevel10k theme directory exists"
else
    info "Warning: Powerlevel10k theme directory not found at: $P10K_THEME_DIR"
fi

echo ""

section "Installation Complete!"

success "Shell prompt setup completed successfully!"
echo ""

info "Installed/Configured components:"
echo "  âœ“ iTerm2 Terminal"
echo "  âœ“ Zsh Shell"
echo "  âœ“ Oh My Zsh Framework"
echo "  âœ“ Powerlevel10k Theme"
echo "  âœ“ zsh-autosuggestions Plugin"
echo "  âœ“ zsh-syntax-highlighting Plugin"
if [ "$FONT_INSTALLED" = true ]; then
    echo "  âœ“ MesloLGS NF Font"
else
    echo "  âš  MesloLGS NF Font (installation may need manual completion)"
fi
echo ""

section "Post-Installation Steps"

info "To complete the setup, please follow these steps:"
echo ""

prompt "1. RELOAD YOUR SHELL CONFIGURATION"
echo ""
echo "   IMPORTANT: You must reload your shell configuration before using 'p10k configure'"
echo ""
echo "   Option A - Source your .zshrc in the current terminal:"
echo "     source ~/.zshrc"
echo ""
echo "   Option B - Restart your terminal:"
echo "     â€¢ If using Terminal.app: Close and reopen it"
echo "     â€¢ If using iTerm2: Close and reopen iTerm2, or open a new window/tab"
echo "     â€¢ The new prompt should appear automatically"
echo ""
echo "   NOTE: The 'p10k' command will only be available AFTER Powerlevel10k is loaded"
echo "         (either by sourcing .zshrc or opening a new terminal)"
echo ""

prompt "2. CONFIGURE iTERM2 FONT (if using iTerm2)"
echo ""
echo "   After opening iTerm2:"
echo "   a) Go to iTerm2 â†’ Settings (or Preferences) â†’ Profiles â†’ Text"
echo "   b) Click 'Change Font' button"
echo "   c) Search for 'MesloLGS'"
echo "   d) Select 'MesloLGS NF Regular'"
echo "   e) Set font size to your preference (recommended: 12-14pt)"
echo "   f) Click 'OK'"
echo ""

prompt "3. CUSTOMIZE POWERLEVEL10K PROMPT (Optional)"
echo ""
echo "   After reloading your shell (step 1), you can customize your prompt:"
echo ""
echo "   Run this command:"
echo "     p10k configure"
echo ""
echo "   This will guide you through customizing:"
echo "   â€¢ Prompt style and colors"
echo "   â€¢ Information segments (Git status, directory, etc.)"
echo "   â€¢ Prompt layout and positioning"
echo ""
echo "   TROUBLESHOOTING: If you get 'command not found: p10k':"
echo "     â€¢ Make sure you've run 'source ~/.zshrc' or opened a new terminal"
echo "     â€¢ Verify Powerlevel10k is installed: ls ~/.oh-my-zsh/custom/themes/powerlevel10k"
echo "     â€¢ Check that ZSH_THEME is set in ~/.zshrc: grep ZSH_THEME ~/.zshrc"
echo ""

if [ "$FONT_INSTALLED" = false ]; then
    prompt "4. MANUAL FONT INSTALLATION (if needed)"
    echo ""
    echo "   If the font was not installed automatically:"
    echo "   a) Download MesloLGS NF fonts from:"
    echo "      https://github.com/romkatv/powerlevel10k-media/raw/master/"
    echo "   b) Double-click each .ttf file to install"
    echo "   c) Or copy to ~/Library/Fonts/"
    echo "   d) Restart iTerm2/Terminal"
    echo ""
fi

prompt "4. TEST THE SETUP (After reloading shell)"
echo ""
echo "   Once you've reloaded your shell (step 1), test that everything works:"
echo ""
echo "   a) Check if p10k command is available:"
echo "      which p10k"
echo "      (Should show: p10k () { ... })"
echo ""
echo "   b) Test p10k configure:"
echo "      p10k configure"
echo ""
echo "   c) Verify in a Git repository:"
echo "      cd /path/to/git/repo"
echo "      (Prompt should show Git branch and status)"
echo ""

if [ "$FONT_INSTALLED" = false ]; then
    prompt "5. MANUAL FONT INSTALLATION (if needed)"
    echo ""
    echo "   If the font was not installed automatically:"
    echo "   a) Download MesloLGS NF fonts from:"
    echo "      https://github.com/romkatv/powerlevel10k-media/raw/master/"
    echo "   b) Double-click each .ttf file to install"
    echo "   c) Or copy to ~/Library/Fonts/"
    echo "   d) Restart iTerm2/Terminal"
    echo ""
fi

prompt "QUICK START - Run this now to test:"
echo ""
echo "   source ~/.zshrc && p10k configure"
echo ""
echo "   This will:"
echo "   1. Reload your shell configuration"
echo "   2. Load Powerlevel10k"
echo "   3. Start the configuration wizard"
echo ""

info "Configuration files:"
echo "  â€¢ Zsh configuration: $HOME/.zshrc"
BACKUP_FILES=$(ls "$HOME"/.zshrc.backup.* 2>/dev/null | head -n1)
if [ -n "$BACKUP_FILES" ]; then
    echo "  â€¢ Backup of previous .zshrc: $BACKUP_FILES"
fi
echo ""

success "Enjoy your beautiful new shell prompt! ðŸš€"
echo ""
info "For more information, visit:"
echo "  â€¢ Oh My Zsh: https://ohmyz.sh"
echo "  â€¢ Powerlevel10k: https://github.com/romkatv/powerlevel10k"
echo "  â€¢ iTerm2: https://iterm2.com"
