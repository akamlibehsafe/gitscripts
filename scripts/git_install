#!/bin/bash

# git_install
# Installs Git, Git LFS, GitHub CLI, and all necessary dependencies on a new Mac computer,
# then provides instructions for configuring Personal Access Tokens.

set -e  # Exit on error

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# Function to print error messages
error() {
    echo -e "${RED}Error: $1${NC}" >&2
    exit 1
}

# Function to print success messages
success() {
    echo -e "${GREEN}$1${NC}"
}

# Function to print info messages
info() {
    echo -e "${YELLOW}$1${NC}"
}

# Function to print prompt messages
prompt() {
    echo -e "${BLUE}$1${NC}"
}

# Function to print section headers
section() {
    echo ""
    echo -e "${BLUE}=== $1 ===${NC}"
    echo ""
}

# Check if running on macOS
if [[ "$OSTYPE" != "darwin"* ]]; then
    error "This script is designed for macOS only. Detected OS: $OSTYPE"
fi

info "Starting Git installation for macOS..."
info "This script will install Git, Git LFS, GitHub CLI, and required dependencies."

# Detect shell type for configuration file
SHELL_NAME=$(basename "$SHELL")
SHELL_CONFIG=""

if [[ "$SHELL_NAME" == "zsh" ]]; then
    SHELL_CONFIG="$HOME/.zshrc"
elif [[ "$SHELL_NAME" == "bash" ]]; then
    SHELL_CONFIG="$HOME/.bashrc"
    # Check if .bash_profile exists (some Mac setups use this instead)
    if [ -f "$HOME/.bash_profile" ] && [ ! -f "$HOME/.bashrc" ]; then
        SHELL_CONFIG="$HOME/.bash_profile"
    fi
else
    info "Warning: Unknown shell '$SHELL_NAME'. Defaulting to .zshrc"
    SHELL_CONFIG="$HOME/.zshrc"
fi

info "Detected shell: $SHELL_NAME"
info "Configuration file: $SHELL_CONFIG"

section "Step 1: Homebrew Installation"

# Check if Homebrew is installed
if command -v brew &> /dev/null; then
    success "Homebrew is already installed"
    info "Updating Homebrew..."
    brew update || info "Homebrew update skipped (may require manual intervention)"
else
    info "Homebrew is not installed. Installing Homebrew..."
    info "This will prompt for your password..."
    
    # Install Homebrew (non-interactive mode where possible)
    /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)" || {
        error "Homebrew installation failed. Please install manually from https://brew.sh"
    }
    
    # Add Homebrew to PATH if not already there (newer Macs with Apple Silicon)
    if [[ -f "/opt/homebrew/bin/brew" ]]; then
        export PATH="/opt/homebrew/bin:$PATH"
        info "Added Homebrew to PATH for this session"
    elif [[ -f "/usr/local/bin/brew" ]]; then
        export PATH="/usr/local/bin:$PATH"
        info "Added Homebrew to PATH for this session"
    fi
    
    success "Homebrew installed successfully"
fi

# Verify brew is in PATH
if ! command -v brew &> /dev/null; then
    error "Homebrew installation completed but 'brew' command not found in PATH.\nPlease add Homebrew to your PATH:\n  For Apple Silicon: export PATH=\"/opt/homebrew/bin:\$PATH\"\n  For Intel: export PATH=\"/usr/local/bin:\$PATH\""
fi

BREW_VERSION=$(brew --version | head -n1)
success "Homebrew ready: $BREW_VERSION"

section "Step 2: Git Installation"

# Check if Git is already installed
if command -v git &> /dev/null; then
    GIT_VERSION=$(git --version)
    success "Git is already installed: $GIT_VERSION"
    info "Checking if update is needed..."
    
    # Install or upgrade Git via Homebrew (will upgrade if newer version available)
    brew install git || brew upgrade git || info "Git installation/upgrade skipped"
else
    info "Installing Git via Homebrew..."
    brew install git || error "Failed to install Git"
fi

# Verify Git installation
if ! command -v git &> /dev/null; then
    error "Git installation failed. Please install manually: brew install git"
fi

GIT_VERSION=$(git --version)
success "Git installed successfully: $GIT_VERSION"

section "Step 3: GitHub CLI Installation"

# Check if GitHub CLI is already installed
if command -v gh &> /dev/null; then
    GH_VERSION=$(gh --version | head -n1)
    success "GitHub CLI is already installed: $GH_VERSION"
    info "Checking if update is needed..."
    
    # Install or upgrade GitHub CLI via Homebrew
    brew install gh || brew upgrade gh || info "GitHub CLI installation/upgrade skipped"
else
    info "Installing GitHub CLI via Homebrew..."
    brew install gh || error "Failed to install GitHub CLI"
fi

# Verify GitHub CLI installation
if ! command -v gh &> /dev/null; then
    error "GitHub CLI installation failed. Please install manually: brew install gh"
fi

GH_VERSION=$(gh --version | head -n1)
success "GitHub CLI installed successfully: $GH_VERSION"

section "Step 4: Git LFS Installation"

# Check if Git LFS is already installed
if command -v git-lfs &> /dev/null || git lfs version &> /dev/null; then
    GIT_LFS_VERSION=$(git lfs version 2>/dev/null || echo "unknown")
    success "Git LFS is already installed: $GIT_LFS_VERSION"
    info "Checking if update is needed..."
    
    # Install or upgrade Git LFS via Homebrew
    brew install git-lfs || brew upgrade git-lfs || info "Git LFS installation/upgrade skipped"
else
    info "Installing Git LFS via Homebrew..."
    brew install git-lfs || error "Failed to install Git LFS"
fi

# Verify Git LFS installation
if ! git lfs version &> /dev/null; then
    error "Git LFS installation failed. Please install manually: brew install git-lfs"
fi

GIT_LFS_VERSION=$(git lfs version)
success "Git LFS installed successfully: $GIT_LFS_VERSION"

# Initialize Git LFS globally
info "Initializing Git LFS globally..."
git lfs install || error "Failed to initialize Git LFS"
success "Git LFS initialized globally"

section "Step 5: Additional Dependencies"

# Check for curl (typically pre-installed on macOS)
if command -v curl &> /dev/null; then
    CURL_VERSION=$(curl --version | head -n1)
    success "curl is available: $CURL_VERSION"
else
    info "Installing curl..."
    brew install curl || error "Failed to install curl"
    success "curl installed"
fi

# Check for jq (JSON processor)
if command -v jq &> /dev/null; then
    JQ_VERSION=$(jq --version)
    success "jq is already installed: $JQ_VERSION"
else
    info "Installing jq (JSON processor)..."
    brew install jq || error "Failed to install jq"
    success "jq installed successfully"
fi

section "Step 6: Git Configuration"

# Check if Git user.name is configured
GIT_NAME=$(git config --global user.name 2>/dev/null || echo "")
GIT_EMAIL=$(git config --global user.email 2>/dev/null || echo "")

if [ -n "$GIT_NAME" ] && [ -n "$GIT_EMAIL" ]; then
    success "Git is already configured:"
    echo "  Name:  $GIT_NAME"
    echo "  Email: $GIT_EMAIL"
    prompt "Do you want to update Git configuration? (y/N)"
    read -r UPDATE_CONFIG
    if [[ "$UPDATE_CONFIG" =~ ^[Yy]$ ]]; then
        GIT_NAME=""
        GIT_EMAIL=""
    fi
fi

if [ -z "$GIT_NAME" ] || [ -z "$GIT_EMAIL" ]; then
    info "Configuring Git user information..."
    
    if [ -z "$GIT_NAME" ]; then
        prompt "Enter your Git user name:"
        read -r GIT_NAME
        if [ -z "$GIT_NAME" ]; then
            info "Skipping Git name configuration"
        else
            git config --global user.name "$GIT_NAME"
            success "Git user.name set to: $GIT_NAME"
        fi
    fi
    
    if [ -z "$GIT_EMAIL" ]; then
        prompt "Enter your Git email:"
        read -r GIT_EMAIL
        if [ -z "$GIT_EMAIL" ]; then
            info "Skipping Git email configuration"
        else
            git config --global user.email "$GIT_EMAIL"
            success "Git user.email set to: $GIT_EMAIL"
        fi
    fi
fi

section "Installation Complete!"

success "All required software has been installed successfully!"
echo ""

info "Installed components:"
echo "  âœ“ Git: $(git --version)"
echo "  âœ“ GitHub CLI: $(gh --version | head -n1)"
echo "  âœ“ Git LFS: $(git lfs version | head -n1)"
echo "  âœ“ Homebrew: $(brew --version | head -n1)"
echo "  âœ“ curl: $(curl --version | head -n1 | cut -d' ' -f1-2)"
echo "  âœ“ jq: $(jq --version)"
echo ""

section "Post-Installation Configuration"

info "To use the Git automation scripts, you need to configure Personal Access Tokens (PATs)."
echo ""

prompt "1. OBTAIN PERSONAL ACCESS TOKENS"
echo ""
echo "   For each GitHub account, generate a PAT:"
echo "   a) Go to GitHub â†’ Settings â†’ Developer settings â†’ Personal access tokens â†’ Tokens (classic)"
echo "   b) Click 'Generate new token (classic)'"
echo "   c) Give it a descriptive name (e.g., 'Git Automation Scripts')"
echo "   d) Select scope: âœ“ repo (Full control of private repositories)"
echo "   e) Click 'Generate token' and COPY the token immediately (you won't see it again)"
echo ""
echo "   Required tokens:"
echo "     â€¢ GH_TOKEN_fortegb - for the 'fortegb' account"
echo "     â€¢ GH_TOKEN_akamlibehsafe - for the 'akamlibehsafe' account"
echo ""

prompt "2. STORE PATs AS ENVIRONMENT VARIABLES"
echo ""
echo "   Add the following to your shell configuration file:"
echo "   File: $SHELL_CONFIG"
echo ""
echo "   Add these lines:"
echo "   export GH_TOKEN_fortegb=\"your_pat_token_here\""
echo "   export GH_TOKEN_akamlibehsafe=\"your_pat_token_here\""
echo ""

# Check if configuration file exists
if [ ! -f "$SHELL_CONFIG" ]; then
    info "Configuration file $SHELL_CONFIG does not exist. It will be created when you add the exports."
else
    # Check if PAT variables are already in the config
    if grep -q "GH_TOKEN_fortegb\|GH_TOKEN_akamlibehsafe" "$SHELL_CONFIG" 2>/dev/null; then
        prompt "Note: PAT variables may already be configured in $SHELL_CONFIG"
        prompt "Please review and update them if needed."
    fi
fi

prompt "3. ACTIVATE THE VARIABLES"
echo ""
echo "   Run one of the following commands to reload your shell configuration:"
echo "   source $SHELL_CONFIG"
echo ""
echo "   Or simply close and reopen your terminal."
echo ""

prompt "4. VERIFY THE SETUP"
echo ""
echo "   Verify that the variables are set:"
echo "   echo \$GH_TOKEN_fortegb"
echo "   echo \$GH_TOKEN_akamlibehsafe"
echo ""
echo "   If they show your tokens, you're all set!"
echo ""

prompt "5. SECURITY BEST PRACTICES"
echo ""
echo "   â€¢ Ensure your shell configuration file has secure permissions:"
echo "     chmod 600 $SHELL_CONFIG"
echo ""
echo "   â€¢ For production use, consider using macOS Keychain or a secrets manager"
echo "   â€¢ Never commit your PAT tokens to version control"
echo ""

section "Git LFS Usage Guide"

info "Git LFS is now installed and initialized globally. Here's how to use it:"
echo ""

prompt "Initialize LFS in a repository:"
echo "  cd /path/to/your/repository"
echo "  git lfs install"
echo ""

prompt "Track specific file types:"
echo "  # Track specific file extensions"
echo "  git lfs track \"*.mp4\"          # Video files"
echo "  git lfs track \"*.mov\"          # Video files"
echo "  git lfs track \"*.zip\"          # Archives"
echo "  git lfs track \"*.psd\"          # Photoshop files"
echo "  git lfs track \"*.pdf\"          # Large PDFs"
echo "  git lfs track \"*.dmg\"          # Disk images"
echo ""
echo "  # Track multiple extensions at once"
echo "  git lfs track \"*.{mp4,mov,zip}\""
echo ""
echo "  # Track files in a specific directory"
echo "  git lfs track \"videos/*\""
echo ""

prompt "Commit the .gitattributes file:"
echo "  git add .gitattributes"
echo "  git commit -m \"Add Git LFS tracking\""
echo ""

prompt "Add and commit large files normally:"
echo "  git add large-file.mp4"
echo "  git commit -m \"Add large file via LFS\""
echo "  git push"
echo ""

prompt "Verify LFS is working:"
echo "  # Check what files are tracked by LFS"
echo "  git lfs ls-files"
echo ""
echo "  # Check LFS status"
echo "  git lfs status"
echo ""

prompt "Example workflow:"
echo "  # Navigate to your repository (e.g., akamlibehsafe/gabinetecamera)"
echo "  cd gabinetecamera"
echo ""
echo "  # Initialize LFS in the repository"
echo "  git lfs install"
echo ""
echo "  # Track the file types you need"
echo "  git lfs track \"*.mp4\" \"*.mov\" \"*.zip\""
echo ""
echo "  # Commit the .gitattributes file"
echo "  git add .gitattributes"
echo "  git commit -m \"Configure Git LFS for large files\""
echo ""
echo "  # Add your large files"
echo "  git add large-video.mp4"
echo "  git commit -m \"Add large video file\""
echo "  git push"
echo ""

info "Important Notes:"
echo "  â€¢ GitHub provides 1 GB of LFS storage and 1 GB/month bandwidth for free accounts"
echo "  â€¢ Files over 100 MB are automatically rejected by GitHub unless using LFS"
echo "  â€¢ If you already committed large files before setting up LFS, you'll need to migrate them"
echo ""

success "Installation and setup instructions complete!"
echo ""

# Clone gitscripts repository and configure PATs
section "Cloning Git Scripts Repository"

GITSCRIPTS_DIR="$HOME/Documents/GitHub/akamlibehsafe"
GITSCRIPTS_REPO="$GITSCRIPTS_DIR/gitscripts"
REPO_URL="https://github.com/akamlibehsafe/gitscripts.git"

# Create the directory if it doesn't exist
if [ ! -d "$GITSCRIPTS_DIR" ]; then
    info "Creating directory: $GITSCRIPTS_DIR"
    mkdir -p "$GITSCRIPTS_DIR" || error "Failed to create directory: $GITSCRIPTS_DIR"
fi

# Check if repository already exists
if [ -d "$GITSCRIPTS_REPO" ]; then
    info "Repository already exists at: $GITSCRIPTS_REPO"
    prompt "Do you want to update it? (Y/n)"
    read -r UPDATE_REPO
    if [[ "$UPDATE_REPO" =~ ^[Nn]$ ]]; then
        info "Skipping repository clone/update"
    else
        info "Updating existing repository..."
        cd "$GITSCRIPTS_REPO" || error "Failed to change to repository directory"
        git pull || info "Git pull completed (may have conflicts)"
        cd - > /dev/null
        success "Repository updated"
    fi
else
    info "Cloning gitscripts repository to: $GITSCRIPTS_REPO"
    info "Repository URL: $REPO_URL"
    echo ""
    
    # Try to clone (will work if repo is public, or prompt for credentials if private)
    if git clone "$REPO_URL" "$GITSCRIPTS_REPO" 2>&1; then
        success "Repository cloned successfully"
    else
        error "Failed to clone repository. You may need to:"
        echo "  1. Ensure the repository exists and is accessible"
        echo "  2. Provide credentials if it's a private repository"
        echo "  3. Clone manually: git clone $REPO_URL $GITSCRIPTS_REPO"
    fi
fi

# Configure PATs from PATs.md file
if [ -f "$GITSCRIPTS_REPO/PATs.md" ]; then
    section "Configuring Personal Access Tokens"
    
    info "Found PATs.md file. Reading PAT tokens..."
    PATS_FILE="$GITSCRIPTS_REPO/PATs.md"
    
    # Use the detected shell configuration file (supports both bash and zsh)
    # SHELL_CONFIG is already set earlier in the script based on detected shell
    
    # Ensure the shell config file exists
    if [ ! -f "$SHELL_CONFIG" ]; then
        info "Creating $SHELL_CONFIG"
        touch "$SHELL_CONFIG"
    fi
    
    # Extract PAT exports from PATs.md
    # Look for lines starting with "export GH_TOKEN_"
    PAT_EXPORTS=$(grep -E "^export GH_TOKEN_" "$PATS_FILE" 2>/dev/null || echo "")
    
    if [ -n "$PAT_EXPORTS" ]; then
        info "Extracted PAT tokens from PATs.md"
        echo ""
        info "Detected shell: $SHELL_NAME"
        info "Configuration file: $SHELL_CONFIG"
        echo ""
        
        # Check if PATs are already in the detected shell config file
        if grep -q "GH_TOKEN_fortegb\|GH_TOKEN_akamlibehsafe" "$SHELL_CONFIG" 2>/dev/null; then
            prompt "PAT tokens already exist in $SHELL_CONFIG"
            prompt "Do you want to update them? (y/N)"
            read -r UPDATE_PATS
            if [[ "$UPDATE_PATS" =~ ^[Yy]$ ]]; then
                # Remove old PAT exports
                info "Removing old PAT exports from $SHELL_CONFIG"
                if [[ "$OSTYPE" == "darwin"* ]]; then
                    sed -i '' '/^export GH_TOKEN_/d' "$SHELL_CONFIG" 2>/dev/null || \
                    info "Note: Could not automatically remove old PATs. Please update manually."
                else
                    sed -i '/^export GH_TOKEN_/d' "$SHELL_CONFIG" 2>/dev/null || \
                    info "Note: Could not automatically remove old PATs. Please update manually."
                fi
            else
                info "Keeping existing PAT configuration"
                PAT_EXPORTS=""  # Don't add new ones
            fi
        fi
        
        # Also check for PATs in the other shell's config file (in case user has both)
        OTHER_SHELL_CONFIG=""
        if [[ "$SHELL_NAME" == "zsh" ]]; then
            # Check bash config files
            if [ -f "$HOME/.bash_profile" ]; then
                OTHER_SHELL_CONFIG="$HOME/.bash_profile"
            elif [ -f "$HOME/.bashrc" ]; then
                OTHER_SHELL_CONFIG="$HOME/.bashrc"
            fi
        elif [[ "$SHELL_NAME" == "bash" ]]; then
            # Check zsh config file
            if [ -f "$HOME/.zshrc" ]; then
                OTHER_SHELL_CONFIG="$HOME/.zshrc"
            fi
        fi
        
        if [ -n "$OTHER_SHELL_CONFIG" ] && grep -q "GH_TOKEN_fortegb\|GH_TOKEN_akamlibehsafe" "$OTHER_SHELL_CONFIG" 2>/dev/null; then
            info "Note: PAT tokens also found in $OTHER_SHELL_CONFIG"
            prompt "Do you want to add PAT tokens to $OTHER_SHELL_CONFIG as well? (y/N)"
            read -r ADD_TO_OTHER
            if [[ "$ADD_TO_OTHER" =~ ^[Yy]$ ]]; then
                # Check if already exists in other file
                if ! grep -q "GH_TOKEN_fortegb\|GH_TOKEN_akamlibehsafe" "$OTHER_SHELL_CONFIG" 2>/dev/null; then
                    echo "" >> "$OTHER_SHELL_CONFIG"
                    echo "# Git Automation Scripts - Personal Access Tokens" >> "$OTHER_SHELL_CONFIG"
                    echo "# Added by git_install script on $(date)" >> "$OTHER_SHELL_CONFIG"
                    echo "$PAT_EXPORTS" >> "$OTHER_SHELL_CONFIG"
                    echo "" >> "$OTHER_SHELL_CONFIG"
                    success "PAT tokens also added to $OTHER_SHELL_CONFIG"
                else
                    info "PAT tokens already exist in $OTHER_SHELL_CONFIG"
                fi
            fi
        fi
        
        if [ -n "$PAT_EXPORTS" ]; then
            # Add PAT exports to the detected shell config file
            info "Adding PAT tokens to $SHELL_CONFIG"
            echo "" >> "$SHELL_CONFIG"
            echo "# Git Automation Scripts - Personal Access Tokens" >> "$SHELL_CONFIG"
            echo "# Added by git_install script on $(date)" >> "$SHELL_CONFIG"
            echo "$PAT_EXPORTS" >> "$SHELL_CONFIG"
            echo "" >> "$SHELL_CONFIG"
            
            success "PAT tokens added to $SHELL_CONFIG"
            echo ""
            info "To activate the tokens in this session, run:"
            echo "  source $SHELL_CONFIG"
            echo ""
            info "Or restart your terminal."
        fi
    else
        info "No PAT exports found in PATs.md file"
        info "Please manually add PAT tokens to $SHELL_CONFIG"
    fi
else
    info "PATs.md file not found at: $GITSCRIPTS_REPO/PATs.md"
    info "You will need to manually configure PAT tokens in $SHELL_CONFIG"
fi

# Check if we're in the gitscripts repository and offer to set up symlinks
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd -P)"
CURRENT_REPO_ROOT="$(cd "$SCRIPT_DIR/.." && pwd -P)"

# Determine which repository to use for symlink setup
# If we're running from within the repo, use that; otherwise use the cloned repo
if [ -f "$CURRENT_REPO_ROOT/setup_symlinks.sh" ]; then
    REPO_ROOT="$CURRENT_REPO_ROOT"
    info "Using current repository at: $REPO_ROOT"
elif [ -f "$GITSCRIPTS_REPO/setup_symlinks.sh" ]; then
    REPO_ROOT="$GITSCRIPTS_REPO"
    info "Using cloned repository at: $REPO_ROOT"
else
    REPO_ROOT="$GITSCRIPTS_REPO"
    info "Repository will be used from: $REPO_ROOT"
fi

SETUP_SCRIPT="$REPO_ROOT/setup_symlinks.sh"

if [ -f "$SETUP_SCRIPT" ]; then
    section "Script Symlink Setup"
    info "Detected Git scripts repository at: $REPO_ROOT"
    echo ""
    info "To use the Git automation scripts from anywhere, you need to create symlinks in ~/bin/"
    echo ""
    prompt "Would you like to set up symlinks now? (Y/n)"
    read -r SETUP_SYMLINKS
    
    if [[ ! "$SETUP_SYMLINKS" =~ ^[Nn]$ ]]; then
        info "Running symlink setup script..."
        echo ""
        bash "$SETUP_SCRIPT"
        echo ""
        success "Symlinks set up successfully!"
        echo ""
        info "You can now use the Git automation scripts from anywhere:"
    else
        info "Symlink setup skipped. You can run it later with:"
        echo "  cd $REPO_ROOT"
        echo "  ./setup_symlinks.sh"
        echo ""
        info "For now, you can use the scripts from the repository directory:"
    fi
else
    info "Note: If you have the gitscripts repository, run setup_symlinks.sh to create symlinks in ~/bin/"
    echo ""
    info "You can use the Git automation scripts:"
fi

echo "  â€¢ git_create_from_local <user/repo>"
echo "  â€¢ git_create_from_remote <user/repo>"
echo "  â€¢ git_push [directory]"
echo ""
success "Happy coding! ðŸš€"

