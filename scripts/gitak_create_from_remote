#!/bin/bash

# gitak_create_from_remote
# Clones an existing GitHub repository to local machine and checks it out for editing.

set -e  # Exit on error

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# Function to print error messages
error() {
    echo -e "${RED}Error: $1${NC}" >&2
    exit 1
}

# Function to print success messages
success() {
    echo -e "${GREEN}$1${NC}"
}

# Function to print info messages
info() {
    echo -e "${YELLOW}$1${NC}"
}

# Check if user/repo argument is provided
if [ $# -ne 1 ]; then
    error "Usage: gitak_create_from_remote <user/repo>\nExample: gitak_create_from_remote fortegb/test"
fi

USER_REPO="$1"

# Validate format (should contain exactly one slash)
if [[ ! "$USER_REPO" =~ ^[^/]+/[^/]+$ ]]; then
    error "Invalid format. Expected: user/repo\nExample: fortegb/test or akamlibehsafe/myproject"
fi

# Parse username and repository name
USERNAME=$(echo "$USER_REPO" | cut -d'/' -f1)
REPO_NAME=$(echo "$USER_REPO" | cut -d'/' -f2)

info "Cloning repository: $USER_REPO"
info "Username: $USERNAME"
info "Repository: $REPO_NAME"

# Determine which PAT to use based on username
if [ "$USERNAME" = "fortegb" ]; then
    PAT_VAR="GH_TOKEN_fortegb"
elif [ "$USERNAME" = "akamlibehsafe" ]; then
    PAT_VAR="GH_TOKEN_akamlibehsafe"
else
    error "Unknown username: $USERNAME\nSupported users: fortegb, akamlibehsafe"
fi

# Retrieve PAT from environment
PAT="${!PAT_VAR}"

if [ -z "$PAT" ]; then
    error "PAT variable $PAT_VAR is not set.\nPlease set it in your shell configuration:\nexport $PAT_VAR=\"your_token_here\""
fi

info "Using PAT from: $PAT_VAR"

# Check if git is installed
if ! command -v git &> /dev/null; then
    error "Git is not installed. Please run gitak_install first."
fi

# Check if Git LFS is installed
HAS_LFS=false
if command -v git-lfs &> /dev/null || command -v git lfs &> /dev/null; then
    HAS_LFS=true
    info "Git LFS is installed"
fi

# Check if repository directory already exists
if [ -d "$REPO_NAME" ]; then
    error "Directory '$REPO_NAME' already exists.\nPlease remove it or choose a different location."
fi

# Get current directory
CURRENT_DIR=$(pwd)
info "Current directory: $CURRENT_DIR"

# Clone the repository using PAT for authentication
info "Cloning repository from GitHub..."

# Construct the clone URL with authentication
CLONE_URL="https://${PAT}@github.com/${USER_REPO}.git"

# Configure Git LFS credentials before cloning if LFS is available
if [ "$HAS_LFS" = true ]; then
    info "Configuring Git LFS for clone..."
    
    # Configure Git credential helper if not already configured
    if ! git config --global credential.helper &>/dev/null; then
        if [[ "$OSTYPE" == "darwin"* ]]; then
            git config --global credential.helper osxkeychain 2>/dev/null || \
            git config --global credential.helper store 2>/dev/null || true
        else
            git config --global credential.helper store 2>/dev/null || true
        fi
    fi
    
    # Store credentials for Git LFS
    printf "protocol=https\nhost=github.com\nusername=${USERNAME}\npassword=${PAT}\n" | git credential approve 2>/dev/null || true
    
    # Disable LFS locking API (not needed for GitHub)
    git config --global lfs.https://github.com/${USERNAME}/${REPO_NAME}.git/info/lfs.locksverify false 2>/dev/null || true
fi

# Attempt to clone (temporarily disable set -e for error handling)
set +e
git clone "$CLONE_URL" 2>&1
CLONE_ERROR=$?
set -e

if [ $CLONE_ERROR -eq 0 ]; then
    success "Repository cloned successfully"
else
    # Check if it's a repository not found error
    set +e
    git ls-remote "$CLONE_URL" &>/dev/null
    LS_REMOTE_ERROR=$?
    set -e
    
    if [ $LS_REMOTE_ERROR -eq 0 ]; then
        error "Failed to clone repository. Check your permissions and network connection."
    else
        error "Repository not found or access denied.\nPlease verify:\n1. The repository exists: https://github.com/$USER_REPO\n2. Your PAT has 'repo' scope\n3. You have access to this repository"
    fi
fi

# Change directory into the cloned repository
if [ -d "$REPO_NAME" ]; then
    cd "$REPO_NAME"
    CLONED_DIR=$(pwd -P)
    success "Changed directory to: $CLONED_DIR"
    
    # Handle Git safe.directory issue for /tmp and other potentially problematic directories
    if [[ "$CLONED_DIR" =~ ^/tmp|^/private/tmp|^/var/tmp ]]; then
        info "Detected temporary directory, ensuring Git safe.directory configuration..."
        SAFE_DIRS=$(git config --global --get-all safe.directory 2>/dev/null || echo "")
        if [ -z "$SAFE_DIRS" ] || ! echo "$SAFE_DIRS" | grep -Fxq "$CLONED_DIR"; then
            git config --global --add safe.directory "$CLONED_DIR"
            info "Added $CLONED_DIR to Git safe.directory list"
        fi
    fi
    
    # Initialize and pull LFS files if LFS is available and repository uses it
    if [ "$HAS_LFS" = true ]; then
        if [ -f .gitattributes ] || git lfs ls-files &>/dev/null; then
            info "Repository uses Git LFS, pulling LFS files..."
            
            # Initialize LFS in the cloned repository
            git lfs install --local 2>/dev/null || git lfs install 2>/dev/null || true
            
            # Pull LFS files
            set +e
            git lfs pull 2>&1 | head -20
            LFS_PULL_ERROR=$?
            set -e
            
            if [ $LFS_PULL_ERROR -eq 0 ]; then
                success "Git LFS files pulled successfully"
            else
                info "Note: Some LFS files may not have been pulled. This is normal if the repository has many large files."
            fi
        fi
    fi
    
    # Update remote URL to clean format (without PAT for security)
    git remote set-url origin "https://github.com/${USER_REPO}.git"
    
    # Show repository status
    info "\nRepository information:"
    echo "  Remote URL: $(git remote get-url origin)"
    echo "  Current branch: $(git branch --show-current)"
    if [ "$HAS_LFS" = true ] && ([ -f .gitattributes ] || git lfs ls-files &>/dev/null 2>&1); then
        LFS_FILE_COUNT=$(git lfs ls-files 2>/dev/null | wc -l | tr -d ' ')
        if [ "$LFS_FILE_COUNT" -gt 0 ]; then
            echo "  Git LFS files: $LFS_FILE_COUNT"
        fi
    fi
    echo "  Repository ready for editing!"
    
    success "\nRepository cloned and ready at: $CLONED_DIR"
else
    error "Repository directory was not created. Clone may have failed."
fi

