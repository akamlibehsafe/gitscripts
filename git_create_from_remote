#!/bin/bash

# git_create_from_remote
# Clones an existing GitHub repository to local machine and checks it out for editing.

set -e  # Exit on error

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# Function to print error messages
error() {
    echo -e "${RED}Error: $1${NC}" >&2
    exit 1
}

# Function to print success messages
success() {
    echo -e "${GREEN}$1${NC}"
}

# Function to print info messages
info() {
    echo -e "${YELLOW}$1${NC}"
}

# Check if user/repo argument is provided
if [ $# -ne 1 ]; then
    error "Usage: git_create_from_remote <user/repo>\nExample: git_create_from_remote fortegb/test"
fi

USER_REPO="$1"

# Validate format (should contain exactly one slash)
if [[ ! "$USER_REPO" =~ ^[^/]+/[^/]+$ ]]; then
    error "Invalid format. Expected: user/repo\nExample: fortegb/test or akamlibehsafe/myproject"
fi

# Parse username and repository name
USERNAME=$(echo "$USER_REPO" | cut -d'/' -f1)
REPO_NAME=$(echo "$USER_REPO" | cut -d'/' -f2)

info "Cloning repository: $USER_REPO"
info "Username: $USERNAME"
info "Repository: $REPO_NAME"

# Determine which PAT to use based on username
if [ "$USERNAME" = "fortegb" ]; then
    PAT_VAR="GH_TOKEN_fortegb"
elif [ "$USERNAME" = "akamlibehsafe" ]; then
    PAT_VAR="GH_TOKEN_akamlibehsafe"
else
    error "Unknown username: $USERNAME\nSupported users: fortegb, akamlibehsafe"
fi

# Retrieve PAT from environment
PAT="${!PAT_VAR}"

if [ -z "$PAT" ]; then
    error "PAT variable $PAT_VAR is not set.\nPlease set it in your shell configuration:\nexport $PAT_VAR=\"your_token_here\""
fi

info "Using PAT from: $PAT_VAR"

# Check if git is installed
if ! command -v git &> /dev/null; then
    error "Git is not installed. Please run git_install first."
fi

# Check if repository directory already exists
if [ -d "$REPO_NAME" ]; then
    error "Directory '$REPO_NAME' already exists.\nPlease remove it or choose a different location."
fi

# Get current directory
CURRENT_DIR=$(pwd)
info "Current directory: $CURRENT_DIR"

# Clone the repository using PAT for authentication
info "Cloning repository from GitHub..."

# Construct the clone URL with authentication
CLONE_URL="https://${PAT}@github.com/${USER_REPO}.git"

# Attempt to clone (temporarily disable set -e for error handling)
set +e
git clone "$CLONE_URL" 2>&1
CLONE_ERROR=$?
set -e

if [ $CLONE_ERROR -eq 0 ]; then
    success "Repository cloned successfully"
else
    # Check if it's a repository not found error
    set +e
    git ls-remote "$CLONE_URL" &>/dev/null
    LS_REMOTE_ERROR=$?
    set -e
    
    if [ $LS_REMOTE_ERROR -eq 0 ]; then
        error "Failed to clone repository. Check your permissions and network connection."
    else
        error "Repository not found or access denied.\nPlease verify:\n1. The repository exists: https://github.com/$USER_REPO\n2. Your PAT has 'repo' scope\n3. You have access to this repository"
    fi
fi

# Change directory into the cloned repository
if [ -d "$REPO_NAME" ]; then
    cd "$REPO_NAME"
    CLONED_DIR=$(pwd -P)
    success "Changed directory to: $CLONED_DIR"
    
    # Handle Git safe.directory issue for /tmp and other potentially problematic directories
    if [[ "$CLONED_DIR" =~ ^/tmp|^/private/tmp|^/var/tmp ]]; then
        info "Detected temporary directory, ensuring Git safe.directory configuration..."
        SAFE_DIRS=$(git config --global --get-all safe.directory 2>/dev/null || echo "")
        if [ -z "$SAFE_DIRS" ] || ! echo "$SAFE_DIRS" | grep -Fxq "$CLONED_DIR"; then
            git config --global --add safe.directory "$CLONED_DIR"
            info "Added $CLONED_DIR to Git safe.directory list"
        fi
    fi
    
    # Show repository status
    info "\nRepository information:"
    echo "  Remote URL: $(git remote get-url origin)"
    echo "  Current branch: $(git branch --show-current)"
    echo "  Repository ready for editing!"
    
    success "\nRepository cloned and ready at: $CLONED_DIR"
else
    error "Repository directory was not created. Clone may have failed."
fi

